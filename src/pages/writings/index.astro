---
import PostCard from "../../components/PostCard.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { buildCollectionPageSchema } from "../../lib/seo-schema";
import { siteConfig } from "../../lib/site";
import { getPostsWithFallback } from "../../lib/writings";

const perPage = 6;
const result = await getPostsWithFallback(siteConfig.substackFeedUrl, 60);
const posts = result.posts.slice(0, perPage);
const hasMore = result.posts.length > perPage;
---

<BaseLayout
  title="Writings"
  path="/writings"
  description="Latest Substack writings by Antoine Mecker."
  jsonLd={buildCollectionPageSchema({
    path: "/writings",
    name: "Writings",
    description: "Essays and research notes on macro, finance, geopolitics, and market structure.",
    about: ["Finance", "Macroeconomics", "Geopolitics", "Digital Assets"],
  })}
>
  <section class="page-hero reveal">
    <div class="page-hero-content">
      <p class="label-bracket reveal-blur text-xs text-accent" style="--d: 0">Substack</p>
      <div class="mt-3 flex flex-col gap-5 md:flex-row md:items-end md:justify-between md:gap-6">
        <div>
          <h1 class="reveal-blur text-5xl font-semibold leading-[0.96] tracking-[-0.04em] md:text-7xl" style="--d: 1">
            Writings and market notes
          </h1>
          <p class="reveal-blur mt-5 max-w-3xl text-lg leading-relaxed text-ink-soft md:text-xl" style="--d: 2">
            Essays and research notes on macro, finance, geopolitics, and market structure.
          </p>
        </div>
        <a
          href={siteConfig.substackUrl}
          target="_blank"
          rel="noreferrer"
          class="reveal-blur interactive-btn btn-primary w-full justify-center px-5 py-3 text-sm md:w-auto md:flex-none"
          style="--d: 3"
          data-track-event="click_substack"
          data-magnetic
        >
          Follow on Substack
        </a>
      </div>
    </div>
  </section>

  {result.source === "cache" && (
    <div class="section-card reveal mt-8 p-4 text-sm text-ink-soft">
      Feed is currently unavailable. Showing the latest cached articles.
    </div>
  )}

  {result.source === "empty" && (
    <div class="section-card reveal mt-8 p-6 text-ink-soft">
      <p>No articles are available in the local cache right now.</p>
      <a
        class="interactive-btn btn-primary mt-4 px-4 py-2 text-sm"
        href={siteConfig.substackUrl}
        target="_blank"
        rel="noreferrer"
        data-track-event="click_substack"
        data-magnetic
      >
        Visit Substack directly
      </a>
    </div>
  )}

  {posts.length > 0 && (
    <section class="mt-10 grid gap-5 md:grid-cols-2">
      {posts.map((post) => <PostCard post={post} />)}
    </section>
  )}

  <section class="reveal mt-10 flex flex-wrap items-center gap-3" style="--d: 1">
    {hasMore && (
      <a class="interactive-btn btn-secondary px-5 py-2.5 text-sm" href="/writings/2" data-magnetic>
        Next page
      </a>
    )}
  </section>
</BaseLayout>
