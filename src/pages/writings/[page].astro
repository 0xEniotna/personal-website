---
import PostCard from "../../components/PostCard.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { siteConfig } from "../../lib/site";
import { getPostsWithFallback } from "../../lib/writings";

export async function getStaticPaths() {
  const perPage = 6;
  const result = await getPostsWithFallback(siteConfig.substackFeedUrl, 120);
  const posts = result.posts;
  const totalPages = Math.max(1, Math.ceil(posts.length / perPage));

  return Array.from({ length: totalPages }, (_, index) => {
    const page = index + 1;

    return {
      params: { page: String(page) },
      props: {
        page,
        totalPages,
        posts: posts.slice(index * perPage, (index + 1) * perPage),
        source: result.source,
      },
    };
  }).filter(({ params }) => params.page !== "1");
}

const { page, totalPages, posts, source } = Astro.props;
const pageTitle = `Writings - Page ${page}`;
---

<BaseLayout
  title={pageTitle}
  path={`/writings/${page}`}
  description="Latest Substack writings by Antoine Mecker."
  robots="noindex,follow"
>
  <section class="page-hero reveal">
    <div class="page-hero-content">
      <p class="label-bracket reveal-blur text-xs text-accent" style="--d: 0">Substack</p>
      <div class="mt-3 flex flex-col gap-5 md:flex-row md:items-end md:justify-between md:gap-6">
        <div>
          <h1 class="reveal-blur text-5xl font-semibold leading-[0.96] tracking-[-0.04em] md:text-7xl" style="--d: 1">
            Writings archive
          </h1>
          <p class="reveal-blur mt-4 text-lg text-ink-soft" style="--d: 2">Page {page} of {totalPages}</p>
        </div>
        <a
          href={siteConfig.substackUrl}
          target="_blank"
          rel="noreferrer"
          class="reveal-blur interactive-btn btn-primary w-full justify-center px-5 py-3 text-sm md:w-auto md:flex-none"
          style="--d: 3"
          data-track-event="click_substack"
          data-magnetic
        >
          Follow on Substack
        </a>
      </div>
    </div>
  </section>

  {source === "cache" && (
    <div class="section-card reveal mt-8 p-4 text-sm text-ink-soft">
      Feed is currently unavailable. Showing cached articles.
    </div>
  )}

  {posts.length > 0 && (
    <section class="mt-10 grid gap-5 md:grid-cols-2">
      {posts.map((post) => <PostCard post={post} />)}
    </section>
  )}

  {posts.length === 0 && (
    <div class="section-card mt-10 p-6">
      <p class="text-ink-soft">No posts on this page yet.</p>
      <a class="interactive-btn btn-primary mt-4 px-4 py-2 text-sm" href="/writings" data-magnetic>
        Back to writings
      </a>
    </div>
  )}

  <nav class="reveal mt-10 flex flex-wrap gap-3" aria-label="Writings pagination">
    {page > 2 && (
      <a class="interactive-btn btn-secondary px-4 py-2 text-sm" href={`/writings/${page - 1}`} data-magnetic>
        Previous page
      </a>
    )}
    {page === 2 && (
      <a class="interactive-btn btn-secondary px-4 py-2 text-sm" href="/writings" data-magnetic>
        Previous page
      </a>
    )}
    {page < totalPages && (
      <a class="interactive-btn btn-dark px-4 py-2 text-sm" href={`/writings/${page + 1}`} data-magnetic>
        Next page
      </a>
    )}
  </nav>
</BaseLayout>
