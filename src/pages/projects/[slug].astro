---
import BaseLayout from "../../layouts/BaseLayout.astro";
import ProjectShowcase from "../../components/ProjectShowcase.astro";
import { projectData } from "../../lib/content";
import { buildProjectPageSchema } from "../../lib/seo-schema";
import type { ProjectItem } from "../../lib/types";

export function getStaticPaths() {
  return projectData.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props as { project: ProjectItem };

const statusStyles: Record<ProjectItem["status"], string> = {
  active: "status-chip-active",
  research: "status-chip-research",
  archived: "status-chip-archived",
};

const detailParagraphs = (project.description ?? project.summary)
  .split("\n")
  .map((line) => line.trim())
  .filter(Boolean);
const pageDescription = detailParagraphs[0] ?? project.summary;
const projectPath = `/projects/${project.slug}`;
const relatedProjects = projectData.filter((item) => item.slug !== project.slug).slice(0, 2);

function humanizeTag(tag: string): string {
  return tag
    .split("-")
    .filter(Boolean)
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(" ");
}

const fallbackFeatures = project.tags
  .slice(0, 3)
  .map((tag) => `${humanizeTag(tag)} capability in active development.`);

const importantFeatures =
  project.highlights && project.highlights.length > 0
    ? project.highlights
    : fallbackFeatures.length > 0
      ? fallbackFeatures
      : ["Core project capabilities are being documented."];
---

<BaseLayout title={project.title} description={pageDescription} path={projectPath} jsonLd={buildProjectPageSchema(project)}>
  <!-- Breadcrumb -->
  <nav class="reveal-blur mb-4 flex items-center gap-2 text-sm text-ink-soft" style="--d: 0" aria-label="Breadcrumb">
    <a href="/projects" class="link-animate hover:text-ink">Projects</a>
    <span aria-hidden="true">/</span>
    <span class="text-ink">{project.title}</span>
  </nav>

  <!-- Hero -->
  <article class="page-hero reveal">
    <div class="page-hero-content">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <p class="label-bracket reveal-blur text-xs text-accent" style="--d: 0">Project</p>
        <span class:list={["status-chip reveal-blur", statusStyles[project.status]]} style="--d: 1">
          {project.status}
        </span>
      </div>
      <h1 class="reveal-blur mt-4 text-5xl font-semibold leading-[0.96] tracking-[-0.04em] text-ink md:text-7xl" style="--d: 1">
        {project.title}
      </h1>
      <p class="reveal-blur mt-6 max-w-4xl text-xl leading-relaxed text-ink-soft" style="--d: 2">{project.summary}</p>

      <div class="reveal-blur mt-7 flex flex-wrap gap-3" style="--d: 3">
        <a href="/projects" class="interactive-btn btn-secondary px-5 py-2.5 text-sm" data-magnetic>Back to Projects</a>
        {project.link && (
          <a
            href={project.link}
            target="_blank"
            rel="noreferrer"
            data-track-event="click_project_repo"
            class="interactive-btn btn-primary px-5 py-2.5 text-sm"
            data-magnetic
          >
            Open repository
          </a>
        )}
      </div>
    </div>
  </article>

  <!-- Showcase -->
  <section class="reveal-scale mt-8 overflow-hidden rounded-xl border border-line/70 bg-white/80 p-5 md:p-7" style="--d: 1">
    <p class="label-bracket mb-4 text-xs text-accent">Showcase</p>
    <ProjectShowcase project={project} />
  </section>

  <!-- Features -->
  <section class="reveal mt-8 grid gap-5 md:grid-cols-2" style="--d: 2">
    <div class="section-card p-6 md:p-8">
      <h2 class="text-2xl font-semibold text-ink md:text-3xl">Key features</h2>
      <ul class="mt-5 space-y-3">
        {importantFeatures.map((item, i) => (
          <li class="reveal-left flex items-start gap-3 text-base leading-relaxed text-ink-soft" style={`--d: ${i + 3}`}>
            <span class="mt-1 flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-md bg-ink/8 text-xs font-bold text-ink">{i + 1}</span>
            <span>{item}</span>
          </li>
        ))}
      </ul>
    </div>

    <div class="section-card p-6 md:p-8">
      <h2 class="text-2xl font-semibold text-ink">Stack & tags</h2>
      <div class="mt-5 flex flex-wrap gap-2">
        {project.tags.map((tag, i) => (
          <span class="reveal-scale chip-light" style={`--d: ${i + 3}`}>{tag}</span>
        ))}
      </div>

      <h2 class="mt-8 text-2xl font-semibold text-ink">Overview</h2>
      <div class="mt-4 space-y-3">
        {detailParagraphs.map((paragraph) => (
          <p class="text-sm leading-relaxed text-ink-soft">{paragraph}</p>
        ))}
      </div>
    </div>
  </section>

  <!-- Related projects -->
  {relatedProjects.length > 0 && (
    <section class="mt-10">
      <h2 class="reveal mb-5 text-3xl font-semibold text-ink" style="--d: 0">Other projects</h2>
      <div class="grid gap-4 md:grid-cols-2">
        {relatedProjects.map((item, i) => (
          <a
            href={`/projects/${item.slug}`}
            class="project-card-enhanced reveal-scale shine-hover"
            style={`--d: ${i + 1}`}
            data-track-event="click_project_open"
            data-tilt
          >
            <div class="flex items-start justify-between gap-3">
              <span class:list={["status-chip", statusStyles[item.status]]}>{item.status}</span>
              <span class="project-card-arrow" aria-hidden="true">&#8599;</span>
            </div>
            <h3 class="mt-4 text-2xl font-semibold text-ink">{item.title}</h3>
            <p class="mt-3 text-sm leading-relaxed text-ink-soft">{item.summary}</p>
            <div class="project-card-tags">
              {item.tags.slice(0, 3).map((tag) => (
                <span class="project-card-tag">{tag}</span>
              ))}
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</BaseLayout>
